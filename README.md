# AI 朋友 (AI Friends) - 你的数字灵魂伴侣

这是一个基于 Preact + Vite 构建的、具有**深度记忆**和**情感系统**的 AI 聊天应用。它不仅是一个聊天机器人，更是一个会成长、有性格、能感知时间的数字伙伴。

![PWA Ready](https://img.shields.io/badge/PWA-Ready-orange)
![AI Model](https://img.shields.io/badge/Model-Multi--Model-blue)
![Database](https://img.shields.io/badge/Database-SQLite%20WASM-green)

## ✨ 功能亮点

### 核心功能
- **🧠 结构化记忆系统**：支持"深度记忆"存储。AI 会永远记住你告诉它的重要点滴，并在对话中自然提及。
- **🎭 动态情感看板**：每个朋友都有实时波动的心情指数、羁绊等级（亲密度），每次对话都会提升。
- **👗 每日状态刷新**：AI 会根据时间自动更新打扮（穿搭）和身体状况（如：有点感冒、精力充沛），每天打开都有新鲜感。
- **⌛ 3 秒静默发送机制**：独创的输入防抖逻辑。支持连续多条发送，系统会在你停止输入 3 秒后自动合并消息并请求 AI，模拟真实的构思过程。
- **🔔 主动关怀系统**：如果你长时间（默认 10 分钟）没理它，AI 会根据性格主动发消息找你（需开启通知权限）。

### 聊天体验
- **🎭 沉浸式角色扮演**：AI 完全代入角色，提示词优化减少出戏，回复简短自然像真人发微信。
- **👥 群聊支持**：多个 AI 朋友可在同一群聊中互动，每个角色有独立标识，AI 能看到完整对话上下文。
- **👤 用户昵称设置**：可自定义用户在聊天中的显示名称，让对话更加真实。
- **📊 角色基本数据**：支持设置角色的性别、身高、体重、年龄、生日，让角色更立体。
- **🖼️ 图片支持**：发送图片给 AI，支持预览和删除。可设置是否显示聊天中的图片。
- **🎨 AI 头像生成**：使用 GLM 生图模型为好友生成独特头像，支持清晰度和尺寸设置，头像生成会参考角色的基本数据。

### 多模型支持
- **🌐 多模型支持**：支持智谱 AI、Google、Groq、火山引擎、魔搭等多种 AI 模型。
- **⚙️ 自定义模型**：每个提供商都支持添加自定义模型，只需填写模型 ID、名称和是否支持视觉。
- **🔌 自定义 Provider**：支持添加多个第三方 API 提供商（如 OpenAI-SB、CloseAI 等），每个 Provider 可配置 Base URL 和 API Key。
- **🔄 429 错误重试**：遇到 429 错误（请求过多）自动重试，使用指数退避策略（1s, 2s, 4s），最大重试次数可配置。

### 消息管理
- **🗑️ 消息删除**：支持删除单条消息，桌面端悬停显示按钮，手机端长按显示。
- **🔄 消息重试**：用户消息可重试，让 AI 重新生成回复。
- **🧹 清空聊天**：支持清空当前会话的所有聊天记录。

### 其他特性
- **📱 PWA 原生体验**：支持安装到桌面或手机，具备离线访问能力和后台系统通知。
- **🔒 私密且安全**：所有对话和数据均存储在本地浏览器数据库（IndexedDB），不上传任何服务器。

## 🛠️ 技术栈

- **前端**: Preact (轻量级 React 替代方案)
- **状态管理**: Preact Signals
- **数据库**: `sql.js` (SQLite WASM) + IndexedDB 持久化
- **UI 组件**: Tailwind CSS
- **AI 接口**: 支持多模型
  - 智谱 AI (GLM-4V/Flash 系列)
  - Google (Gemma/Gemini) - 自动适配 Gemma 不支持 system role 的情况
  - Groq (Llama)
  - 火山引擎 (豆包)
  - 魔搭 (通义千问)
- **离线支持**: Service Worker (PWA)

## 🚀 快速开始

### 前置要求
- Node.js 18+
- AI API Key (在应用"设置"中配置，支持多家提供商)
  - [智谱 AI](https://open.bigmodel.cn/)
  - [Google AI](https://aistudio.google.com/)
  - [Groq](https://console.groq.com/)
  - [火山引擎](https://www.volcengine.com/)
  - [魔搭](https://modelscope.cn/)

### 安装步骤
1. 克隆仓库
   ```bash
   git clone https://github.com/your-username/ai-friends-app.git
   cd ai-friends-app
   ```
2. 安装依赖
   ```bash
   bun install
   ```
3. 启动开发服务器
   ```bash
   bun run dev
   ```
4. 打开浏览器访问 `http://localhost:5173`，在**设置**中填入你的 API Key。

## 📖 工程说明

关于项目的深度技术实现逻辑，请参阅根目录下的 `GEMINI.md` 开发文档。

## 📝 更新日志

### v2.0 - 近期重大更新

#### Prompt 系统重构
- ✅ 创建独立的 `prompts.ts` 管理 Prompt 配置
- ✅ 设置页支持自定义 Prompt 前缀/后缀
- ✅ 添加详细时间信息（年月日时分、星期、时段、问候语）
- ✅ 角色信息添加基本数据（性别、身高、体重、年龄、生日）
- ✅ 记忆信息添加时间戳，防止时间错位
- ✅ 优化 Prompt 减少 AI 长篇回复，每次回复一两句即可

#### 设置页重构
- ✅ 添加 Tab 导航：基础/模型/Prompts/数据
- ✅ 统一 UI 风格，使用 Card 布局
- ✅ Prompts 配置实时应用到 AI 调用

#### 自定义模型系统
- ✅ 支持添加多个自定义 Provider（第三方 API 平台）
- ✅ 每个 Provider 可配置 Base URL 和 API Key
- ✅ 每个 Provider 可添加多个自定义模型
- ✅ 自定义模型只需填：模型 ID、名称、是否支持视觉
- ✅ 默认 Provider 也支持添加自定义模型

#### 好友系统优化
- ✅ 添加角色基本数据：性别、身高、体重、年龄、生日
- ✅ 好友详情页支持编辑基本数据
- ✅ 好友详情页添加自动回复开关和等待时间设置
- ✅ 生成头像时使用基本数据信息，更准确

#### Bug 修复
- ✅ 修复 AI 陷入自说自话循环的问题
- ✅ 修复同一条用户消息显示两次的问题
- ✅ 修复默认 Provider 的自定义模型无法保存问题
- ✅ 修复手机端删除消息困难问题
- ✅ 修复 Gemma 不支持 role: system 问题
- ✅ 修复好友基本数据无法保存问题
- ✅ 修复消息重复发送问题

#### 其他优化
- ✅ 添加 429 错误重试机制（指数退避策略）
- ✅ 消息操作按钮优化（桌面端悬停、手机端长按）
- ✅ 删除腾讯混元（不支持浏览器 CORS）
- ✅ 简化默认 Prompt，减少冗余说明

## 💡 使用技巧

### 1. 自定义模型配置
- 设置 → 模型 → 自定义 API 提供商 → 添加 Provider
- 填写 Provider ID、名称、Base URL、API Key
- 添加模型：填写模型 ID、名称、是否支持视觉

### 2. 429 错误处理
- 设置 → 模型 → 最大重试次数 (429 错误)
- GLM/GLM-4V 等模型常遇到 429 错误，建议设置为 3-5 次

### 3. 角色设定
- 添加好友时填写性别、身高、体重、年龄
- 好友详情页可随时修改基本数据
- 生成头像时会使用这些数据，让头像更符合角色设定

### 4. Prompt 调优
- 设置 → Prompts → 自定义系统提示词
- 可调整角色扮演指令、对话方式、特殊标记等
- 修改后记得保存配置

## 📜 许可证

MIT License
